Title: SGE集群流程设计
Date: 2015-09-18
Category: work
Tags: SGE, pipeline

>由于华大基因等公司的大量使用，SGE计算集群在生物信息领域仍然有比较广泛的应用；生物大数据时代的到来，可靠、易维护的分析流程也日益重要。

本文阐述本人在一次16S/ITS流程设计与搭建时的心得，大体思路如下：

## 流程整体思路

![pipeline](http://ww3.sinaimg.cn/mw1024/95202659gw1ew6qpe8f4ej21a413atf7.jpg)

其中：

* src中的程序，包含比较复杂的逻辑实现（包含基于string.Tempelate的R语言脚本模板）；
* script中脚本，规定程序的调用接口，默认值设置，帮助文档等内容；
* bin中的功能模块，规定了脚本的调用顺序，以及读取和写出功能的配置文件，一个功能中的脚本之间不应该同时存在两个资源需求较大的脚本，并且不应该存在功能逻辑上明显可以区分的脚本；
* Pipeline中是对功能模块的具体调用，以及针对不同集群系统的任务投递规则，功能模块之间串并行调用的选择，以及每个功能的资源分配等实现；

其他来源的程序（如[qiime](http://qiime.org)、[RDPTools](https://github.com/rdpstaff)等），也必须通过script重新定义接口，以符合当前流程的需要，并且在script中调用。

## R和Python的交叉开发

R语言中有大量可靠的统计分析函数，以及强大的科学作图功能，结合python更加强大的组织能力，两种语言（以及perl语言）结合开发是生物信息分析过程中较为常见的行为。

在python中使用r语言有rpy2等方式，但是这种方式并不是特别容易理解，利用python中的字符串模板，将R语言的实现逻辑和python的组织架构分离，并调用系统命令运行R语言，这样的好处是直接调用系统环境的R，方便更换R语言环境；

为了避免R中的`$`符号使用和默认的模板分隔符冲突，改写Template，并将delimiter值改变为`@#`；

思路如下：

![python_with_R](http://ww1.sinaimg.cn/mw1024/95202659gw1ew6qpe521zj212y11agpg.jpg)

## 流程搭建步骤

通过将四种不同逻辑分离，在易于维护的同时，搭建其他不同的流程也将会变得比较清晰；一般流程搭建的步骤为：

1. 设计功能模块的流程，明确需要用到的软件，以及需要开发的程序；
2. 根据具体的分析要求，对上述软件和程序进行接口包装，流程只需要对接口负责，改变软件版本或者软件具体内容并不需要重新修改流程；
3. 完成未有需要开发的程序开发，程序中尽量实现最小功能实现，避免并行处理，通过任务分配完成并行，最大限度地使用计算资源；完成单一程序的测试等；
4. 功能模块测试，资源消耗的统计；
5. 制定功能模块的调用规则，分配资源，对不产生依赖的功能之间并行投递任务，产生依赖的功能串行投递任务；
